@model IList<Lotto.Models.Poll_Out>
@{
    ViewBag.Title = "OutList";
    Layout = "~/Views/Shared/_Admin.cshtml";
    var totalAmount = 0;
    var totalAmountDiscount = 0;
    var totalAmountWin = 0;
}

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <i class="mr-2 fa fa-list"></i>
                <strong class="card-title">ดูโพยแทงออกทั้งหมด</strong>
            </div>
            <div class="card-body">
                <table id="bootstrap-data-table" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>จำนวนโพย</th>
                            <th>ยอดแทง</th>
                            <th>ยอดหัก %</th>
                            <th>ยอดถูก</th>
                            <th>สถานะโพย</th>
                            <th>วิธีส่ง</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                        <tr>
                            <td>@String.Format("{0:n0}", Int32.Parse(item.Count))</td>
                            <td>@String.Format("{0:n0}", Int32.Parse(item.Amount))</td>
                            <td>@String.Format("{0:n0}", Int32.Parse(item.AmountDiscount))</td>
                            <td>@String.Format("{0:n0}", Int32.Parse(item.AmountWin))</td>
                            @if (item.Status == "0")
                            {
                                <td>ใหม่</td>
                            }
                            else
                            {
                                <td>ส่งแล้ว</td>
                                totalAmount += Int32.Parse(item.Amount);
                                totalAmountDiscount += Int32.Parse(item.AmountDiscount);
                                totalAmountWin += Int32.Parse(item.AmountWin);                                 
                            }
                            @if (item.Status == "0")
                            {
                                <td>ยังไม่ได้ส่ง</td>
                            }
                            else if (item.Status == "1")
                            {
                                <td>พิมพ์ส่ง</td>
                            }
                            else if(item.Status == "2")
                            {
                                <td>ส่งผ่านเว็บไปที่ - @item.Name</td>
                            }
                            else { }
                            <td><button type="button" onclick="OutPoll('@item.Send_To_UID','@item.Period_ID')" class="btn btn-sm btn-danger" data-toggle="modal" data-target="#OutPollModal" data-backdrop="static" data-keyboard="false">ดูโพย</button></td>
                        </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <th>รวมส่งแล้ว</th>
                            <th>@String.Format("{0:n}", totalAmount)</th>
                            <th>@String.Format("{0:n}", totalAmountDiscount)</th>
                            <th>@String.Format("{0:n}", totalAmountWin)</th>
                            <th></th>
                            <th>สรุป</th>
                            <th>@String.Format("{0:n}", (totalAmountWin-totalAmountDiscount))</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="OutPollModal" tabindex="-1" role="dialog" aria-labelledby="OutPollModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document" style="max-width:50%;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="display:inline-block" id="OutPollModalLabel">รายการแทงออก <span id="headernumber"></span> <span id="headertype"></span></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table table-striped table-bordered out-poll-data-table">
                    <thead>
                        <tr>
                            <th>ลำดับ</th>
                            <th>ยอดแทง</th>
                            <th>ยอดหัก %</th>
                            <th>ยอดถูก</th>
                            <th>สถานะโพย</th>
                            <th>วิธีส่ง</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot>
                        <tr>
                            <th>รวม</th>
                            <th id="amount"></th>
                            <th id="amountdis"></th>
                            <th id="amountwin"></th>
                            <th></th>
                            <th>สรุป</th>
                            <th id="total"></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>
@*<script src="~/Assets/js/Outlist.js"></script>*@
<script>
    getOutPoll = '@Url.Action("getOutPoll", "Admin")';
    (function ($) {
        $('#bootstrap-data-table').DataTable({
            lengthMenu: [[10, 20, 50, -1], [10, 20, 50, "All"]],
            fixedHeader: {
                footer: true
            }
        });

    })(jQuery);
    function OutPoll (ToUid,PeriodID){
    $.ajax({
        url: getOutPoll,
        data: { SendToUID: ToUid, PeriodID: PeriodID },
        type: "POST",
        dataType: "json",
        success: function (data) {
            //console.log(data);
            var amount = 0;
            var amount_discount = 0;
            var amount_win = 0;
            OutTable.clear();
            $.each(data, function (index, value) {
                //total_amount += parseInt(value.Amount);                
                if (value.Status == "0") {
                    value.Name = "ยังไม่ได้ส่ง";
                    value.Status = "ใหม่";
                }
                else if (value.Status == "1")
                {
                    value.Name = "พิมพ์ส่ง";
                    value.Status = "ส่งแล้ว";
                }
                else {
                    value.Name = "ส่งไปที่ " + value.Name;
                    value.Status = "ส่งแล้ว";
                    
                }
                amount += parseInt(value.Amount);
                amount_discount += parseInt(value.AmountDiscount);
                amount_win += parseInt(value.AmountWin);
                OutTable.row.add(value);
            });
            $("#amount").html(nwc(amount));
            $("#amountdis").html(nwc(amount_discount));
            $("#amountwin").html(nwc(amount_win));
            $("#total").html(nwc(amount_win-amount_discount));
            OutTable.draw();
            //$('#total_amount').html(nwc(total_amount));
            //initialPoll2();
        },
        error: function (xhr, ajaxOptions, thrownError) {
            alert("error");
        }
    });
}

var OutTable = $('.out-poll-data-table').DataTable({
    "lengthMenu": [[10, 20, 50, -1], [10, 20, 50, "All"]],
    "order": [[0, "desc"]],
    "paging": true,
    "lengthChange": true,
    "searching": true,
    "ordering": true,
    "info": true,
    "autoWidth": true,
    "data": [],
    "columns": [
        {
            "title": "ลำดับ",
            "data": null,
            "render": function (data, type, row, meta) {
                return nwc(row.Row);
            }
        },
        {
            "title": "ยอดแทง",
            "data": null,
            "render": function (data, type, row, meta) {
                return nwc(row.Amount);
            }
        },
        {
            "title": "ยอดหัก %",
            "data": null,
            "render": function (data, type, row, meta) {
                return nwc(row.AmountDiscount);
            }
        },
        {
            "title": "ยอดถูก",
            "data": null,
            "render": function (data, type, row, meta) {
                return nwc(row.AmountWin);
            }
        },
        {
            "title": "สถานะโพย",
            "data": "Status"
        },
        {
            "title": "วิธีส่ง",
            "data": "Name"
        },
        {
            "title": "",
            "data": null,
            "render": function (data, type, row, meta) {
                var Url = '@Url.Action("OutListDetail", "Admin")/' + row.ID;
                return '<a type="button" class="btn btn-sm btn-primary" ' +
                    'target="_blank" href="' + Url+'"' +
                    '>ดูโพย</a>';
            }
        }
    ]
});
</script>

