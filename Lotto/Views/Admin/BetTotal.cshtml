@model IList<Lotto.Models.total_bet>
@{
    ViewBag.Title = "BuyTotal";
    Layout = "~/Views/Shared/_Admin.cshtml";
}

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <i class="mr-2 fa fa-file-text-o"></i>
                <strong class="card-title">ยอดสรุปเป็นใบ</strong>
            </div>
            <div class="card-body">
                <table id="bootstrap-data-table" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>สมาชิก</th>
                            <th>โพยทั้งหมด</th>
                            <th>รับแล้ว</th>
                            <th>ยอดแทง</th>
                            <th>ยอดรับ</th>
                            <th>ยอดหัก%</th>
                            <th>ยอดถูก</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            if (item.UID != "0")
                            {
                                var totalPoll = Int32.Parse(item.Reject) + Int32.Parse(item.Receive);
                                <tr>
                                    <td>@item.Name</td>
                                    <td>@totalPoll</td>
                                    <td>@item.Receive</td>
                                    <td>@item.Amount</td>
                                    <td>@item.AmountReceive</td>
                                    <td>@item.AmountDiscount</td>
                                    <td>0</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-primary get-balance" data-uid="@item.UID" data-uname="@item.Name" data-toggle="modal" data-target="#totalBalance" data-backdrop="static" data-keyboard="false">สรุปยอด</button>
                                        <button type="button" class="btn btn-sm btn-success get-keep" data-uid="@item.UID" data-uname="@item.Name" data-toggle="modal" data-target="#totalKeep" data-backdrop="static" data-keyboard="false">ใบแจ้งยอด</button>
                                        <button type="button" class="btn btn-sm btn-warning get-user-poll" data-uid="@item.UID" data-toggle="modal" data-target="#checkPollModal" data-backdrop="static" data-keyboard="false">ดูโพย</button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="checkPollModal" tabindex="-1" role="dialog" aria-labelledby="checkPollModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document" style="max-width:90%;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="checkPollModalLabel">ดูโพย</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table table-striped table-bordered user-poll-data-table">
                    <thead></thead>
                    <tbody></tbody>
                    <tfoot>
                        <tr>
                            <th>รวม</th>
                            <th><span id="pollCount"></span> ใบ</th>
                            <th></th>
                            <th></th>
                            <th><span id="total_amount"></span></th>
                            <th><span id="total_receive"></span></th>
                            <th><span id="total_discount"></span></th>
                            <th>0</th>
                            <th>สรุป</th>
                            <th><span id="total_discount_2"></span></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="checkModal" tabindex="-1" role="dialog" aria-labelledby="checkModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document" style="max-width:90%;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close x-modal" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h3>สรุปโพย</h3>
                    </div>
                    <div class="col-md-6 right">
                        <button type="button" class="btn btn-sm btn-warning hidden" id="editPoll">แก้ไข</button>
                        <button type="button" class="btn btn-sm btn-danger hidden" id="reject">คืนทั้งใบ</button>
                        <button type="button" class="btn btn-sm btn-default" id="printPoll">พิมพ์</button>
                    </div>
                    <div class="col-md-12">
                        <div id="printPollArea">
                        <hr />
                        <div class="col-md-12">
                            <form action="#" method="post" enctype="multipart/form-data" class="form-horizontal">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="row form-group">
                                            <div class="col col-md-5"><label class="form-control-label">โพยใบที่</label></div>
                                            <div class="col-12 col-md-7"><div id="poll_number" class="form-control-label bold"></div></div>
                                        </div>
                                        <div class="row form-group">
                                            <div class="col col-md-5"><label class="form-control-label">สถานะ</label></div>
                                            <div class="col-12 col-md-7"><div id="receive_status" class="form-control-label bold"></div></div>
                                        </div>
                                        <div class="row form-group">
                                            <div class="col col-md-5"><label class="form-control-label">ยอดแทงใบนี้</label></div>
                                            <div class="col-12 col-md-7"><div id="amount" class="form-control-label bold"></div></div>
                                        </div>
                                        <div class="row form-group">
                                            <div class="col col-md-5"><label class="form-control-label">ยอดรับใบนี้</label></div>
                                            <div class="col-12 col-md-7"><div id="receive" class="form-control-label bold"></div></div>
                                        </div>
                                        <div class="row form-group">
                                            <div class="col col-md-5"><label class="form-control-label">ยอดหัก%ใบนี้</label></div>
                                            <div class="col-12 col-md-7"><div id="discount" class="form-control-label bold"></div></div>
                                        </div>
                                        <div class="row form-group">
                                            <div class="col col-md-5"><label class="form-control-label">วันที่แทง</label></div>
                                            <div class="col-12 col-md-7"><div id="poll_date" class="form-control-label bold"></div></div>
                                        </div>
                                        <div class="row form-group">
                                            <div class="col col-md-5"><label class="form-control-label">แทงโดย</label></div>
                                            <div class="col-12 col-md-7"><div id="poll_by" class="form-control-label bold"></div></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="row form-group">
                                            <div class="col col-md-5"><label class="form-control-label">วันที่รับ</label></div>
                                            <div class="col-12 col-md-7"><div id="receive_date" class="form-control-label bold"></div></div>
                                        </div>

                                        <div class="row form-group">
                                            <div class="col col-md-5"><label class="form-control-label">โพยหมายเลข</label></div>
                                            <div class="col-12 col-md-7"><div id="poll_id" class="form-control-label bold"></div></div>
                                        </div>
                                        <div class="row form-group">
                                            <div class="col col-md-5"><label class="form-control-label">จำนวนโพย</label></div>
                                            <div class="col-12 col-md-7"><div id="total_poll" class="form-control-label bold"></div></div>
                                        </div>
                                        <div class="row form-group">
                                            <div class="col col-md-5"><label class="form-control-label">รับแล้ว</label></div>
                                            <div class="col-12 col-md-7"><div id="receive_poll" class="form-control-label bold"></div></div>
                                        </div>
                                        <div class="row form-group">
                                            <div class="col col-md-5"><label class="form-control-label">ยอดคืนงวดนี้</label></div>
                                            <div class="col-12 col-md-7"><div id="r_amount" class="form-control-label bold"></div></div>
                                        </div>
                                        <div class="row form-group">
                                            <div class="col col-md-5"><label class="form-control-label">ยอดรับงวดนี้</label></div>
                                            <div class="col-12 col-md-7"><div id="receive_amount" class="form-control-label bold"></div></div>
                                        </div>
                                        <div class="row form-group">
                                            <div class="col col-md-5"><label class="form-control-label">ยอดหัก%งวดนี้</label></div>
                                            <div class="col-12 col-md-7"><div id="t_discount" class="form-control-label bold"></div></div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <hr />
                        <div class="col-md-12">
                            <div class="row" id="poll">

                            </div>
                        </div>
                        </div>
                        <div id="action-area" class="col-md-12 right hidden">
                            <button type="button" class="btn btn-sm btn-success x-modal" id="sendPoll" data-dismiss="modal">ยืนยันการแก้ไข</button>
                            <button type="button" class="btn btn-sm btn-danger x-modal" data-dismiss="modal">ยกเลิก</button>
                        </div>
                    </div>
                </div>
            </div>
            @*<div class="modal-footer">
                    <button type="button" class="btn btn-primary">ตรวจ</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">ยกเลิก</button>
                </div>*@
        </div>
    </div>
</div>

<div class="modal fade" id="totalBalance" tabindex="-1" role="dialog" aria-labelledby="totalBalanceLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
           <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="printBalanceArea">
                <br />
                <h4 class="center">ใบสรุปยอดเงิน ง<span id="balanceUser"></span> งวดวันที่ <span id="balancePeriod"></span></h4><hr/>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="printBalance">พิมพ์</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ปิด</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="totalKeep" tabindex="-1" role="dialog" aria-labelledby="totalKeepLabel" aria-hidden="true">
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
           <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="printKeepArea">
                <br />
                <h4 class="center">ใบสรุปยอดเก็บ <span id="keepUser"></span> งวดวันที่ <span id="keepPeriod"></span></h4><hr />
                 <div class="row">
                    <div class="col-md-12">
                         <div class="row form-group">
                            <div class="col col-md-5"><label class="form-control-label">หวยรัฐบาล</label></div>
                            <div class="col-12 col-md-7"><div id="keeptotalSum" class="form-control-label bold"></div></div>
                        </div>
                         <div class="row form-group">
                            <div class="col col-md-5"><label class="form-control-label">ยอดเก็บ</label></div>
                            <div class="col-12 col-md-7"><div id="keepSum" class="form-control-label bold"></div></div>
                        </div>
                         <div class="row form-group">
                            <div class="col col-md-5"><label class="form-control-label">ยอดจ่าย</label></div>
                            <div class="col-12 col-md-7"><div id="keepSumw" class="form-control-label bold"></div></div>
                        </div>
                         <div class="row form-group">
                            <div class="col col-md-5"><label class="form-control-label">รวมทั้งหมด</label></div>
                            <div class="col-12 col-md-7"><div id="keepSum_last" class="form-control-label bold"></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="printKeep">พิมพ์</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ปิด</button>
            </div>
        </div>
    </div>
</div>

<script src="~/Assets/js/admin_list.js"></script>
<script src="~/Assets/js/admin_list_edit.js"></script>
<script src="~/Assets/js/sweetalert2.all.min.js"></script>

<script>
    (function ($) {

        getUserPoll = '@Url.Action("List", "Admin")';
        getPoll = '@Url.Action("getPoll", "User")';
        getPollHeadDetail = '@Url.Action("getPoll", "Admin")';
        RejectPoll = '@Url.Action("RejectPoll", "Admin")';
        addPoll = '@Url.Action("AddPoll", "Admin")';
        getUserBetResult = '@Url.Action("GetUserBetResult", "Admin")';
        getUserTotalBalance = '@Url.Action("GetUserTotalBalance", "Admin")';

        $('#bootstrap-data-table').DataTable({
            lengthMenu: [[10, 20, 50, -1], [10, 20, 50, "All"]],
        });

        var pollTable = $('.user-poll-data-table').DataTable({
            "lengthMenu": [[10, 20, 50, -1], [10, 20, 50, "All"]],
            "paging": true,
            "lengthChange": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "autoWidth": true,
            "data": [],
            "columns": [
            {
                "title": "สมาชิก",
                "data": "name"
            },
            {
                "title": "โพยใบที่",
                "data": "poll_number"
            },
            {
                "title": "หมายเลขโพย",
                "data": "ID"
            },
            {
                "title": "สถานะ",
                "data": "Receive"
            },
            {
                "title": "ยอดแทง",
                "data": "Amount"
            },
            {
                "title": "ยอดรับ",
                "data": "Amount"
            },
            {
                "title": "ยอดหัก%",
                "data": "Discount"
            },
            {
                "title": "ยอดถูก",
                "data": "gg",
                "defaultContent": "0"
            },
            {
                "title": "วันที่ส่ง",
                "data": "create_date"
            },
            {
                "title": "",
                "data": null,
                "render": function ( data, type, row, meta ) {
                    return '<button type="button" class="btn btn-sm btn-primary showPoll" '+
                    'data-uid="'+row.UID+'" '+
                    'data-pollNumber="'+row.poll_number+'" '+
                    'data-cBy="'+row.Create_By+'" '+
                    'data-cDate="'+row.create_date+'" '+
                    'data-discount="'+row.Discount+'" '+
                    'data-areceiv="'+row.Amount+'" '+
                    'data-amount="'+row.Amount+'" '+
                    'data-receive="'+row.Receive+'" '+
                    'data-pCount="'+row.pollCount+'" '+
                    'data-id="'+row.ID+'" '+
                    'data-toggle="modal" data-target="#checkModal"  data-backdrop="static" data-keyboard="false">ดูโพย</button';
                }
            }
            ]
        });

        $('.get-balance').click(function () {
            $('#balanceUser').html($(this).data("uname"));
            $('#balancePeriod').html($("#todayDate").html());
            var id = $(this).data('uid');
            $.ajax({
                url: getUserTotalBalance,
                data: { uID: id },
                type: "POST",
                dataType: "json",
                success: function (data) {
                    alert(JSON.stringify(data));
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert("error");
                }
            });
        });

         $('.get-keep').click(function () {
            $('#keepUser').html($(this).data("uname"));
            $('#keepPeriod').html($("#todayDate").html());
            var id = $(this).data('uid');
            var keepSum = 0;
            var keepSumw = 0;
            $.ajax({
                url: getUserBetResult,
                data: { uID: id },
                type: "POST",
                dataType: "json",
                success: function (data) {
                    //alert(JSON.stringify(data));
                    $.each(data, function (index, value) {
                        keepSum += parseInt(value.Discount);
                        keepSumw += parseInt(value.Win);
                    });
                    $('#keeptotalSum').html(keepSum);
                    $('#keepSum').html(keepSum);
                    $('#keepSumw').html(keepSumw);
                    $('#keepSum_last').html(Math.abs(keepSum-keepSumw));
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert("error");
                }
            });
        });

        $(".get-user-poll").click(function () {
            var id = $(this).data('uid');
            $.ajax({
                url: getUserPoll,
                data: { UID: id },
                type: "POST",
                dataType: "json",
                success: function (data) {
                    //alert(JSON.stringify(data));

                    var pollCount = 0;
                    var total_amount = 0;
                    var total_receive = 0;
                    var total_discount = 0;
                    var reject_amount = 0;

                    pollTable.clear();
                    $.each(data, function (index, value) {
                        pollCount += 1;
                        if (value.Receive == "1")
                        {
                            value.Receive = "รับแล้ว";
                            total_amount += parseInt(value.Amount);
                            total_receive += parseInt(value.Amount);
                            total_discount += parseInt(value.Discount);
                        }
                        else
                        {
                            value.Receive = "คืนทั้งใบ";
                            total_amount += parseInt(value.Amount);
                            total_receive += 0;
                            reject_amount += parseInt(value.Amount);
                            value.Discount = 0
                        }
                        //alert(JSON.stringify(value));
                        pollTable.row.add(value);
                    });
                    pollTable.draw();
                    $('#pollCount').html(pollCount);
                    $('#total_amount').html(total_amount);
                    $('#total_receive').html(total_receive);
                    $('#total_discount').html(total_discount);
                    $('#total_discount_2').html(total_discount);
                    initialPoll();
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert("error");
                }
            });
        });

         $('#printBalance').click(function () {

              var printContents = document.getElementById('printBalanceArea');

              var newWin = window.open('','Print-Window');

              newWin.document.open();

              newWin.document.write('<html><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css"></head><body onload="window.print()">'+printContents.innerHTML+'</body></html>');

              newWin.document.close();

              setTimeout(function(){newWin.close();},10);
        });

         $('#printKeep').click(function () {
            var printContents = document.getElementById('printKeepArea');

              var newWin = window.open('','Print-Window');

              newWin.document.open();

              newWin.document.write('<html><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css"></head><body onload="window.print()">'+printContents.innerHTML+'</body></html>');

              newWin.document.close();

              setTimeout(function(){newWin.close();},10);
        });
    })(jQuery);
</script>

